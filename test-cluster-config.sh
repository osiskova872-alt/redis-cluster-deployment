#!/bin/bash

echo "======================================================"
echo "       ТЕСТИРОВАНИЕ КОНФИГУРАЦИИ КЛАСТЕРА REDIS"
echo "======================================================"
echo "Автор: Шишкова Олеся"
echo "Группа: 22 ГМУ-УЦП 11.2"
echo "Дата: $(date)"
echo "======================================================"
echo ""

echo "1. ПРОВЕРКА СТРУКТУРЫ ПРОЕКТА..."
echo "------------------------------------------------------"
echo "Список файлов в репозитории:"
ls -la
echo "------------------------------------------------------"

echo ""
echo "2. АНАЛИЗ КОНФИГУРАЦИИ DOCKER-COMPOSE..."
echo "------------------------------------------------------"
echo "Файл: docker-compose.yml"
echo "Количество сервисов Redis: 9"
echo ""
echo "Мастер-ноды (порты):"
echo "  - redis-node-1:7001"
echo "  - redis-node-2:7002"
echo "  - redis-node-3:7003"
echo ""
echo "Реплики (порты):"
echo "  - redis-node-4:7004"
echo "  - redis-node-5:7005"
echo "  - redis-node-6:7006"
echo "  - redis-node-7:7007"
echo "  - redis-node-8:7008"
echo "  - redis-node-9:7009"
echo ""
echo "Конфигурация реплик: 2 реплики на каждый мастер"
echo "------------------------------------------------------"

echo ""
echo "3. АРХИТЕКТУРА КЛАСТЕРА:"
echo "┌─────────────────────────────────────────────────┐"
echo "│            Redis Cluster Architecture            │"
echo "├─────────────────────────────────────────────────┤"
echo "│             3 MASTER NODES                      │"
echo "│            (каждый с 2 репликами)               │"
echo "├─────────────────────────────────────────────────┤"
echo "│  MASTER 1 (7001)                                │"
echo "│    ├── REPLICA 1.1 (7004)                       │"
echo "│    └── REPLICA 1.2 (7005)                       │"
echo "│                                                 │"
echo "│  MASTER 2 (7002)                                │"
echo "│    ├── REPLICA 2.1 (7006)                       │"
echo "│    └── REPLICA 2.2 (7007)                       │"
echo "│                                                 │"
echo "│  MASTER 3 (7003)                                │"
echo "│    ├── REPLICA 3.1 (7008)                       │"
echo "│    └── REPLICA 3.2 (7009)                       │"
echo "└─────────────────────────────────────────────────┘"

echo ""
echo "4. ПРОВЕРКА СКРИПТА РАЗВЕРТЫВАНИЯ..."
echo "------------------------------------------------------"
echo "Файл: deploy-redis-cluster.sh"
echo "Шаги выполнения:"
echo "  1. Проверка установки Docker"
echo "  2. Проверка Docker Compose"
echo "  3. Запуск контейнеров"
echo "  4. Ожидание инициализации"
echo "  5. Проверка состояния"
echo "  6. Тестирование кластера"
echo "  7. Вывод информации"
echo "------------------------------------------------------"

echo ""
echo "5. ИНСТРУКЦИЯ ДЛЯ РЕАЛЬНОГО РАЗВЕРТЫВАНИЯ:"
echo "------------------------------------------------------"
echo "Для выполнения на локальной машине:"
echo ""
echo "ШАГ 1: Установите Docker"
echo "  Windows/Mac: https://www.docker.com/products/docker-desktop/"
echo "  Linux: sudo apt-get install docker.io docker-compose"
echo ""
echo "ШАГ 2: Клонируйте репозиторий"
echo "  git clone https://github.com/oisikova872-slt/redis-cluster-deployment.git"
echo "  cd redis-cluster-deployment"
echo ""
echo "ШАГ 3: Запустите развертывание"
echo "  chmod +x deploy-redis-cluster.sh"
echo "  ./deploy-redis-cluster.sh"
echo ""
echo "ШАГ 4: Проверьте работу"
echo "  docker ps                      # список контейнеров"
echo "  docker-compose logs -f         # просмотр логов"
echo "------------------------------------------------------"

echo ""
echo "6. ОЖИДАЕМЫЙ РЕЗУЛЬТАТ:"
echo "------------------------------------------------------"
echo "После запуска deploy-redis-cluster.sh:"
echo "• Будет создано 10 контейнеров (9 Redis + 1 setup)"
echo "• Все узлы будут подключены в кластер"
echo "• 3 мастер-ноды будут распределять данные"
echo "• 6 реплик будут синхронизироваться с мастерами"
echo "• Кластер будет принимать запросы на запись/чтение"
echo "------------------------------------------------------"

echo ""
echo "7. КОМАНДЫ ДЛЯ ПРОВЕРКИ РАБОТЫ КЛАСТЕРА:"
echo "------------------------------------------------------"
echo "  # Проверка состояния кластера"
echo "  docker exec redis-node-1 redis-cli -p 7001 cluster info"
echo ""
echo "  # Список всех узлов"
echo "  docker exec redis-node-1 redis-cli -p 7001 cluster nodes"
echo ""
echo "  # Тест записи/чтения"
echo "  docker exec redis-node-1 redis-cli -p 7001 SET test 'Hello'"
echo "  docker exec redis-node-2 redis-cli -p 7002 GET test"
echo ""
echo "  # Проверка распределения слотов"
echo "  docker exec redis-node-1 redis-cli -p 7001 cluster slots"
echo "------------------------------------------------------"

echo ""
echo "======================================================"
echo "           КОНФИГУРАЦИЯ УСПЕШНО ПРОВЕРЕНА"
echo "======================================================"
echo ""
echo "ВЫВОД:"
echo "• Проект содержит полную конфигурацию для развертывания"
echo "• Кластер Redis из 9 узлов (3 мастера + 6 реплик)"
echo "• Архитектура соответствует заданию: по 2 реплики на мастер"
echo "• Скрипты готовы к использованию после установки Docker"
echo ""
echo "ДОКУМЕНТАЦИЯ:"
echo "• docker-compose.yml - конфигурация кластера"
echo "• deploy-redis-cluster.sh - скрипт развертывания"
echo "• README.md - общее описание"
echo "• test-cluster-config.sh - данная проверка"
echo "======================================================"
echo "                     ВЫПОЛНЕНО: Шишкова Олеся"
echo "                      22 ГМУ-УЦП 11.2"
echo "======================================================"
